<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pro - 專業客戶關係管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: "PingFang TC", sans-serif; overflow: hidden; }
        #wrapper { display: flex; width: 100%; height: 100vh; }
        #sidebar-wrapper { width: 260px; background: #fff; border-right: 1px solid #e3e8ee; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-brand { padding: 1.5rem; font-size: 1.25rem; font-weight: 800; color: #3b82f6; border-bottom: 1px solid #f3f4f6; }
        .sidebar-menu { flex-grow: 1; padding: 10px; }
        .nav-item-link { display: flex; align-items: center; padding: 12px 20px; color: #64748b; text-decoration: none; border-radius: 8px; cursor: pointer; margin-bottom: 5px; transition: 0.2s; }
        .nav-item-link:hover { background: #f8fafc; color: #1e293b; }
        .nav-item-link.active { background: #eff6ff; color: #3b82f6; font-weight: 600; }
        .nav-item-link i { margin-right: 12px; }
        #page-content-wrapper { flex-grow: 1; overflow-y: auto; padding: 2rem 3rem; }
        .stat-card { background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e3e8ee; height: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 8px; }
        .stat-value { font-size: 2.2rem; font-weight: 800; color: #1e293b; }
        .page-section { display: none; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        .table-card { background: #fff; border-radius: 12px; border: 1px solid #e3e8ee; overflow: hidden; margin-top: 1.5rem; }
        .custom-table th { background-color: #f8fafc; padding: 12px 20px; font-size: 0.8rem; color: #64748b; text-transform: uppercase; border-bottom: 1px solid #e3e8ee; }
        .custom-table td { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; font-size: 0.95rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-brand"><i class="bi bi-rocket-takeoff-fill"></i> CRM Pro</div>
            <div class="sidebar-menu">
                <a class="nav-item-link active" id="l-overview" onclick="switchTab('overview', this)"><i class="bi bi-grid-1x2-fill"></i> 數據總覽</a>
                <a class="nav-item-link" id="l-customers" onclick="switchTab('customers', this)"><i class="bi bi-people-fill"></i> 客戶管理</a>
                <a class="nav-item-link" id="l-events" onclick="switchTab('events', this)"><i class="bi bi-calendar-event-fill"></i> 活動管理</a>
                <a class="nav-item-link" id="l-marketing" onclick="switchTab('marketing', this)"><i class="bi bi-envelope-at-fill"></i> 郵件行銷</a>
            </div>
            <div class="p-3 border-top d-flex align-items-center gap-2 text-muted small">
                <div class="rounded-circle bg-light border d-flex align-items-center justify-content-center" style="width:32px;height:32px;">AD</div>
                <div>Admin User</div>
            </div>
        </div>

        <div id="page-content-wrapper">
            <!-- OVERVIEW -->
            <div id="overview" class="page-section active">
                <h3 class="fw-bold mb-4">數據總覽 Dashboard</h3>
                <div class="row g-4 mb-4" id="kpi-row"></div>
                <div class="row g-4 mb-4">
                    <div class="col-md-6"><div class="stat-card"><h5>轉換漏斗</h5><div id="funnel-area"></div><div class="text-center mt-4 pt-3 border-top"><h1 class="text-success fw-bold" id="funnel-rate">0.00%</h1><small>整體轉換率</small></div></div></div>
                    <div class="col-md-6"><div class="stat-card"><h5>客戶公司分佈</h5><div style="height:250px;"><canvas id="segmentChart"></canvas></div></div></div>
                </div>
                <div class="table-card"><div class="p-3 border-bottom fw-bold">各活動轉換排行榜</div><table class="custom-table w-100"><tbody id="topEventsBody"></tbody></table></div>
            </div>

            <!-- CUSTOMERS -->
            <div id="customers" class="page-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h3 class="m-0">客戶管理</h3><span class="text-muted fw-bold" id="customerCountDisplay"></span></div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="openModal('importModal')"><i class="bi bi-file-earmark-spreadsheet"></i> 匯入 CSV</button>
                        <button class="btn btn-primary" onclick="openModal('addCustModal')"><i class="bi bi-plus"></i> 新增客戶</button>
                    </div>
                </div>
                <div class="table-card"><table class="custom-table w-100"><thead><tr><th>姓名/Email</th><th>公司</th><th class="text-center">活動數</th><th class="text-center">操作</th></tr></thead><tbody id="custTableBody"></tbody></table></div>
            </div>

            <!-- EVENTS -->
            <div id="events" class="page-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h3 class="m-0">活動管理</h3><span class="text-muted fw-bold" id="eventCountDisplay"></span></div>
                    <button class="btn btn-primary" onclick="openModal('addEvModal')"><i class="bi bi-plus"></i> 建立活動</button>
                </div>
                <div class="table-card"><table class="custom-table w-100"><thead><tr><th>活動名稱</th><th>日期</th><th>地點</th><th class="text-center">報名人數</th><th class="text-center">出席率</th></tr></thead><tbody id="evTableBody"></tbody></table></div>
            </div>

            <!-- MARKETING -->
            <div id="marketing" class="page-section">
                <h3 class="mb-4">郵件行銷</h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6>1. 選擇收件人</h6>
                            <div class="border rounded mb-3" style="max-height:250px; overflow-y:auto;">
                                <table class="table table-sm small mb-0"><thead><tr><th><input type="checkbox" id="mktAll" onchange="mktSelectAll()"></th><th>姓名</th></tr></thead><tbody id="mktPickList"></tbody></table>
                            </div>
                            <h6>2. 設定與範本</h6>
                            <select class="form-select mb-2" id="mktTpl" onchange="applyTpl()"><option value="">-- 選擇範本 --</option></select>
                            <button class="btn btn-sm btn-link p-0 mb-2" onclick="saveAsTpl()">+ 另存為新範本</button>
                            <input type="text" id="mktCampaignName" class="form-control mb-2" placeholder="廣告活動名稱">
                            <label class="small fw-bold">排程時間 (選填)</label>
                            <input type="datetime-local" id="mktTime" class="form-control mb-3">
                            <div class="p-2 mb-3 bg-light rounded border"><input type="email" id="testEmailInput" class="form-control form-control-sm mb-1" placeholder="測試收件信箱"><button class="btn btn-sm btn-outline-secondary w-100" onclick="sendTestEmail()">發送測試信</button></div>
                            <button class="btn btn-success w-100 py-2 fw-bold" onclick="createCampaign()">建立排程並啟動</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="stat-card">
                            <h6 class="fw-bold">3. 編輯內容 ({name} 代入姓名)</h6>
                            <input type="text" id="mktSub" class="form-control mb-2" placeholder="主旨">
                            <textarea id="mktBody" class="form-control" rows="18" placeholder="內容..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="table-card mt-4"><div class="p-3 border-bottom fw-bold">行銷活動紀錄</div><table class="custom-table w-100"><thead><tr><th>名稱</th><th>狀態</th><th class="text-center">收件</th><th class="text-center">開啟</th><th class="text-center">開啟率</th><th class="text-end">排程時間</th></tr></thead><tbody id="mktHistoryBody"></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="importModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5>批次匯入客戶 (CSV)</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-muted">格式：姓名,Email,電話,公司,活動(多個用逗號)<br>範例：王小明,wang@test.com,0912345678,台積電,"2024尾牙,2025春酒"</p><textarea id="csvInput" class="form-control" rows="10" placeholder="請貼上 CSV 內容..."></textarea></div><div class="modal-footer"><button class="btn btn-primary" onclick="importCSV()">開始匯入</button></div></div></div></div>
    
    <div class="modal fade" id="addCustModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>新增客戶</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="c_n" class="form-control mb-2" placeholder="姓名"><input id="c_e" class="form-control mb-2" placeholder="Email"><input id="c_c" class="form-control mb-2" placeholder="公司"><input id="c_p" class="form-control mb-2" placeholder="電話"><input id="c_ev" class="form-control mb-2" placeholder="參加活動 (用逗號分隔)"></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveCustomer()">儲存客戶</button></div></div></div></div>
    
    <div class="modal fade" id="addEvModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>建立活動</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="e_n" class="form-control mb-2" placeholder="活動名"><input id="e_d" type="datetime-local" class="form-control mb-2"><input id="e_l" class="form-control mb-2" placeholder="地點"></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveEvent()">確認建立</button></div></div></div></div>
    
    <div class="modal fade" id="customerModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 id="mdName"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="mdBody"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allCustomers = [], emailTemplates = [], selectedIds = new Set(), charts = {};
        const modals = {};

        window.onload = async () => {
            modals.addCust = new bootstrap.Modal(document.getElementById('addCustModal'));
            modals.addEv = new bootstrap.Modal(document.getElementById('addEvModal'));
            modals.import = new bootstrap.Modal(document.getElementById('importModal'));
            modals.detail = new bootstrap.Modal(document.getElementById('customerModal'));
            await loadDashboard(); await fetchCustomers();
        };

        function switchTab(id, el) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
            if(id==='overview') loadDashboard(); if(id==='customers') fetchCustomers(); if(id==='events') loadEvents(); if(id==='marketing') initMarketing();
        }

        async function loadDashboard() {
            const res = await fetch('/customers/stats'); const d = await res.json();
            document.getElementById('kpi-row').innerHTML = `<div class="col-md-3"><div class="stat-card"><div class="stat-label">總客戶數</div><div class="stat-value">${d.total_customers}</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-label">總活動數</div><div class="stat-value">${d.total_events}</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-label text-success">總購買次數</div><div class="stat-value text-success">${d.total_purchases}</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-label text-success">累計營收額</div><div class="stat-value text-success">NT$${d.total_revenue.toLocaleString()}</div></div></div>`;
            document.getElementById('funnel-area').innerHTML = `<div class="mb-2 d-flex justify-content-between"><span>活動報名人數: ${d.unique_event_attendees}</span></div><div class="progress mb-3" style="height:12px;"><div class="progress-bar" style="width:100%"></div></div><div class="mb-2 d-flex justify-content-between"><span>成交轉化人數: ${d.converted_purchasers}</span></div><div class="progress" style="height:12px;"><div class="progress-bar bg-success" style="width:${d.conversion_rate}%"></div></div>`;
            document.getElementById('funnel-rate').innerText = d.conversion_rate + '%';
            
            const ctx = document.getElementById('segmentChart');
            if(charts.seg) charts.seg.destroy();
            charts.seg = new Chart(ctx, { type:'doughnut', data:{ labels: d.customer_segments.map(s=>s.company), datasets:[{data: d.customer_segments.map(s=>s.count), backgroundColor:['#3b82f6','#8b5cf6','#ec4899','#10b981','#f59e0b'], borderWidth:0}]}, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{position:'bottom',labels:{boxWidth:12}}}}});
            document.getElementById('topEventsBody').innerHTML = d.top_converting_events.map(e => `<tr><td><span class="event-name-bg">${e.name}</span></td><td class="text-end fw-bold">${e.registrations}</td><td class="text-end text-success">${e.converted}</td><td class="text-end text-primary">${e.rate}%</td></tr>`).join('');
        }

        async function fetchCustomers() {
            const res = await fetch('/customers/'); allCustomers = await res.json();
            document.getElementById('custTableBody').innerHTML = allCustomers.map(c => `<tr><td><div class="fw-bold">${c.name}</div><small class="text-muted">${c.email}</small></td><td>${c.company||'-'}</td><td class="text-center fw-bold">${c.events ? c.events.length : 0}</td><td class="text-center"><i class="bi bi-trash text-danger" onclick="delCustomer(${c.id})" style="cursor:pointer"></i></td></tr>`).join('');
            document.getElementById('customerCountDisplay').innerText = `目前總計: ${allCustomers.length} 位客戶`;
        }

        async function saveCustomer() {
            const data = { 
                name: document.getElementById('c_n').value, 
                email: document.getElementById('c_e').value, 
                company: document.getElementById('c_c').value, 
                phone: document.getElementById('c_p').value,
                events_str: document.getElementById('c_ev').value
            };
            if(!data.name || !data.email) { alert('姓名與 Email 是必填！'); return; }
            
            try {
                const res = await fetch('/customers/', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
                if(res.ok) { alert('新增成功！'); modals.addCust.hide(); await fetchCustomers(); } 
                else { const err = await res.json(); alert('儲存失敗：' + (err.detail || '未知錯誤')); } 
            } catch(e) { alert('系統錯誤：' + e.message); }
        }

        async function importCSV() {
            const txt = document.getElementById('csvInput').value.trim();
            if(!txt) { alert('請貼上內容'); return; }
            
            const lines = txt.split('\n');
            const dataList = [];
            for (let line of lines) {
                const parts = line.split(','); 
                if(parts.length >= 2) {
                    dataList.push({
                        name: parts[0].trim(),
                        email: parts[1].trim(),
                        phone: parts[2]?.trim(),
                        company: parts[3]?.trim(),
                        events_str: parts[4]?.replace(/"/g, '').trim()
                    });
                }
            }
            
            try {
                const res = await fetch('/customers/import', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(dataList)});
                const result = await res.json();
                if(res.ok) {
                    alert(result.message);
                    if(result.errors && result.errors.length) alert('部分匯入失敗：\n' + result.errors.join('\n'));
                    modals.import.hide();
                    await fetchCustomers();
                } else { alert('匯入失敗：' + (result.detail || '未知錯誤')); }
            } catch(e) { alert('系統錯誤：' + e.message); }
        }

        async function delCustomer(id) { if(confirm('確定刪除？')) { await fetch(`/customers/${id}`, {method:'DELETE'}); await fetchCustomers(); } }

        async function loadEvents() {
            const res = await fetch('/customers/events/'); const data = await res.json();
            document.getElementById('evTableBody').innerHTML = data.map(e => `<tr><td><div class="fw-bold">${e.name}</div></td><td>${new Date(e.date).toLocaleDateString()}</td><td>${e.location||'-'}</td><td class="text-center">${e.attendee_count}</td><td class="text-center">${e.attendance_rate}%</td></tr>`).join('');
            document.getElementById('eventCountDisplay').innerText = `目前總計: ${data.length} 個活動`;
        }

        async function saveEvent() {
            const data = { name: document.getElementById('e_n').value, date: document.getElementById('e_d').value, location: document.getElementById('e_l').value };
            const res = await fetch('/customers/events/', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            if(res.ok) { alert('活動建立成功！'); modals.addEv.hide(); await loadEvents(); }
        }

        async function initMarketing() {
            const res = await fetch('/customers/marketing/templates'); emailTemplates = await res.json();
            document.getElementById('mktTpl').innerHTML = '<option value="">-- 選擇範本 --</option>' + emailTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById('mktPickList').innerHTML = allCustomers.map(c => `<tr><td><input type="checkbox" class="mkt-chk" value="${c.id}" onchange="updateMktSel()"></td><td>${c.name}</td></tr>`).join('');
            loadCampaignHistory();
        }

        function mktSelectAll() { let c = document.getElementById('mktAll').checked; document.querySelectorAll('.mkt-chk').forEach(x => x.checked = c); updateMktSel(); }
        function updateMktSel() { selectedIds.clear(); document.querySelectorAll('.mkt-chk:checked').forEach(x => selectedIds.add(parseInt(x.value))); }
        function applyTpl() { const t = emailTemplates.find(x => x.id == document.getElementById('mktTpl').value); if(t) { document.getElementById('mktSub').value = t.subject; document.getElementById('mktBody').value = t.body; } }
        async function saveAsTpl() {
            const n = prompt('請輸入範本名稱：'); if(!n) return;
            await fetch('/customers/marketing/templates', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n, subject:document.getElementById('mktSub').value, body:document.getElementById('mktBody').value})});
            alert('已儲存範本'); initMarketing();
        }

        async function createCampaign() {
            const data = { name: document.getElementById('mktCampaignName').value, subject: document.getElementById('mktSub').value, body: document.getElementById('mktBody').value, customer_ids: Array.from(selectedIds), scheduled_at: document.getElementById('mktTime').value || null };
            if(!data.name) { alert('請輸入活動名稱'); return; }
            if(selectedIds.size === 0) { alert('請至少選擇一位收件人'); return; }
            await fetch('/customers/marketing/campaigns', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            alert('成功排程！'); setTimeout(loadCampaignHistory, 500);
        }

        async function loadCampaignHistory() {
            const res = await fetch('/customers/marketing/campaigns'); const data = await res.json();
            document.getElementById('mktHistoryBody').innerHTML = data.map(c => `<tr><td>${c.name}</td><td><span class="badge bg-primary">${c.status}</span></td><td class="text-center fw-bold">${c.total_recipients}</td><td class="text-center fw-bold">${c.opened_count}</td><td class="text-center fw-bold text-primary">${c.open_rate}%</td><td class="text-end small">${c.scheduled_at ? new Date(c.scheduled_at).toLocaleString() : '立即'}</td></tr>`).join('') || '<tr><td colspan="6" class="text-center p-4 text-muted">目前尚無紀錄</td></tr>';
        }

        async function sendTestEmail() {
            await fetch('/customers/marketing/test', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email: document.getElementById('testEmailInput').value, subject: '【測試】' + document.getElementById('mktSub').value, body: document.getElementById('mktBody').value})});
            alert('測試郵件已寄出！');
        }

        function openModal(id) { modals[id.startsWith('addC')?'addCust': id.startsWith('addE')?'addEv': 'import'].show(); }
    </script>
</body>
</html>