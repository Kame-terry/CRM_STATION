<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pro - 專業客戶關係管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: "PingFang TC", sans-serif; overflow: hidden; }
        #wrapper { display: flex; width: 100%; height: 100vh; }
        #sidebar-wrapper { width: 260px; background: #fff; border-right: 1px solid #e3e8ee; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-brand { padding: 1.5rem; font-size: 1.25rem; font-weight: 800; color: #3b82f6; border-bottom: 1px solid #f3f4f6; }
        .sidebar-menu { flex-grow: 1; padding: 10px; }
        .nav-item-link { display: flex; align-items: center; padding: 12px 20px; color: #64748b; text-decoration: none; border-radius: 8px; cursor: pointer; margin-bottom: 5px; }
        .nav-item-link:hover { background: #f8fafc; }
        .nav-item-link.active { background: #eff6ff; color: #3b82f6; font-weight: 600; }
        #page-content-wrapper { flex-grow: 1; overflow-y: auto; padding: 2rem 4rem; }
        .stat-card { background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e3e8ee; height: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 8px; }
        .stat-value { font-size: 2.5rem; font-weight: 800; color: #1e293b; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .table-card { background: #fff; border-radius: 12px; border: 1px solid #e3e8ee; overflow: hidden; margin-top: 1.5rem; }
        .custom-table th { background-color: #f8fafc; padding: 16px 24px; font-size: 0.85rem; color: #64748b; border-bottom: 1px solid #e3e8ee; }
        .custom-table td { padding: 20px 24px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; font-size: 0.95rem; }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-brand"><i class="bi bi-rocket-takeoff-fill"></i> CRM Pro</div>
            <div class="sidebar-menu">
                <a class="nav-item-link active" onclick="switchTab('overview', this)"><i class="bi bi-grid-1x2-fill me-2"></i> 數據總覽</a>
                <a class="nav-item-link" onclick="switchTab('customers', this)"><i class="bi bi-people-fill me-2"></i> 客戶管理</a>
                <a class="nav-item-link" onclick="switchTab('events', this)"><i class="bi bi-calendar-event-fill me-2"></i> 活動管理</a>
                <a class="nav-item-link" onclick="switchTab('marketing', this)"><i class="bi bi-envelope-at-fill me-2"></i> 郵件行銷</a>
            </div>
        </div>
        <div id="page-content-wrapper">
            <div id="overview" class="page-section active">
                <h3 class="fw-bold mb-4">數據總覽 Dashboard</h3>
                <div class="row g-4 mb-5" id="kpi-row"></div>
                <div class="row g-4 mb-5">
                    <div class="col-md-6"><div class="stat-card"><h5>轉換漏斗</h5><div id="funnel-area" class="mt-4"></div><div class="text-center mt-4 pt-3 border-top"><h1 class="text-success fw-bold" id="funnel-rate" style="font-size:3.5rem">0%</h1></div></div></div>
                    <div class="col-md-6"><div class="stat-card"><h5>客戶公司分佈</h5><div style="height:250px;"><canvas id="segmentChart"></canvas></div></div></div>
                </div>
                <div class="table-card">
                    <div class="p-3 border-bottom fw-bold text-primary"><i class="bi bi-trophy"></i> 活動轉換成效排行</div>
                    <table class="custom-table w-100">
                        <thead>
                            <tr>
                                <th>活動名稱</th>
                                <th class="text-end">報名人數</th>
                                <th class="text-end">成交人數</th>
                                <th class="text-end">轉換率 %</th>
                            </tr>
                        </thead>
                        <tbody id="topEventsBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="customers" class="page-section">
                <div class="d-flex justify-content-between align-items-center mb-4"><div><h3 class="m-0">客戶管理</h3><span id="custCount" class="text-muted fw-bold"></span></div><button class="btn btn-primary" onclick="openModal('addCustModal')">新增客戶</button></div>
                <div class="table-card"><table class="custom-table w-100"><thead><tr><th>姓名/Email</th><th>公司</th><th class="text-center">操作</th></tr></thead><tbody id="custTableBody"></tbody></table></div>
            </div>
            <div id="events" class="page-section">
                <div class="d-flex justify-content-between align-items-center mb-4"><div><h3 class="m-0">活動管理</h3><span id="evCount" class="text-muted fw-bold"></span></div><button class="btn btn-primary" onclick="openModal('addEvModal')">建立活動</button></div>
                <div class="table-card"><table class="custom-table w-100"><thead><tr><th>活動名稱</th><th>日期</th><th class="text-center">出席率</th></tr></thead><tbody id="evTableBody"></tbody></table></div>
            </div>
            <!-- 4. MARKETING -->
            <div id="marketing" class="page-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="m-0">郵件行銷</h3>
                    <div id="gmail-status">
                        <button class="btn btn-outline-danger btn-sm" onclick="startAuth()">
                            <i class="bi bi-google"></i> 連結 Google 帳號
                        </button>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6>1. 選擇收件人</h6>
                            <div class="border rounded mb-3" style="max-height:250px; overflow-y:auto;"><table class="table table-sm small mb-0"><thead><tr><th><input type="checkbox" id="mktAll" onchange="mktSelectAll(this)"></th><th>姓名</th></tr></thead><tbody id="mktPickList"></tbody></table></div>
                            <h6>2. 設定活動</h6>
                            <select class="form-select mb-2" id="mktTpl" onchange="applyTpl()"><option value="">-- 選擇範本 --</option></select>
                            <button class="btn btn-sm btn-link p-0 mb-2" onclick="saveAsTpl()">+ 另存為範本</button>
                            <input type="text" id="mktCampaignName" class="form-control mb-2" placeholder="廣告活動名稱">
                            <label class="small fw-bold">排程發送時間 (選填)</label>
                            <input type="datetime-local" id="mktTime" class="form-control mb-3">
                            <div class="p-2 mb-3 bg-light rounded border text-center"><input type="email" id="testEmailInput" class="form-control form-control-sm mb-1" placeholder="測試信箱"><button class="btn btn-sm btn-outline-secondary w-100" onclick="sendTestEmail()">測試</button></div>
                            <button class="btn btn-success w-100 py-2 fw-bold" onclick="createCampaign()">啟動發送</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="stat-card">
                            <h6>3. 編輯內容 ({name} 代入姓名)</h6>
                            <input type="text" id="mktSub" class="form-control mb-2" placeholder="主旨">
                            <textarea id="mktBody" class="form-control" rows="18" style="height:500px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="table-card mt-4">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-primary"><i class="bi bi-clock-history"></i> 活動發送紀錄</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadCampaignHistory()"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <table class="custom-table w-100">
                        <thead>
                            <tr>
                                <th>活動名稱</th>
                                <th>狀態</th>
                                <th class="text-center">收件人數</th>
                                <th class="text-center">已開啟</th>
                                <th class="text-center">開啟率 %</th>
                                <th class="text-end">排程時間</th>
                            </tr>
                        </thead>
                        <tbody id="mktHistoryBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addCustModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>新增客戶</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="c_n" class="form-control mb-2" placeholder="姓名"><input id="c_e" class="form-control mb-2" placeholder="Email"><input id="c_c" class="form-control mb-2" placeholder="公司"><input id="c_p" class="form-control mb-2" placeholder="電話"></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveCustomer()">儲存</button></div></div></div></div>
    <div class="modal fade" id="addEvModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>建立活動</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="e_n" class="form-control mb-2" placeholder="活動名"><input id="e_d" type="datetime-local" class="form-control mb-2"><input id="e_l" class="form-control mb-2" placeholder="地點"></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveEvent()">建立</button></div></div></div></div>
    <div class="modal fade" id="customerModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 id="mdName"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="mdBody"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allCustomers = [], emailTemplates = [], selectedIds = new Set(), charts = {};
        const modals = {};

        window.onload = async () => {
            modals.addCust = new bootstrap.Modal(document.getElementById('addCustModal'));
            modals.addEv = new bootstrap.Modal(document.getElementById('addEvModal'));
            modals.detail = new bootstrap.Modal(document.getElementById('customerModal'));
            await loadDashboard(); await fetchCustomers();
        };

        function switchTab(id, el) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
            if(id==='overview') loadDashboard(); if(id==='customers') fetchCustomers(); if(id==='events') loadEvents(); if(id==='marketing') initMarketing();
        }

        async function loadDashboard() {
            const res = await fetch('/customers/stats'); const d = await res.json();
            document.getElementById('kpi-row').innerHTML = `<div class="col-md-3"><div class="stat-card"><div class="stat-label">總客戶</div><div class="stat-value">${d.total_customers}</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-label">總活動</div><div class="stat-value">${d.total_events}</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-label text-success">總購買</div><div class="stat-value text-success">${d.total_purchases}</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-label text-success">總營收</div><div class="stat-value text-success">NT$${d.total_revenue.toLocaleString()}</div></div></div>`;
            document.getElementById('funnel-area').innerHTML = `<div class="progress mb-2" style="height:12px;"><div class="progress-bar" style="width:100%">報名:${d.unique_event_attendees}</div></div><div class="progress" style="height:12px;"><div class="progress-bar bg-success" style="width:${d.conversion_rate}%">成交:${d.converted_purchasers}</div></div>`;
            document.getElementById('funnel-rate').innerText = d.conversion_rate + '%';
            const ctx = document.getElementById('segmentChart');
            if(charts.seg) charts.seg.destroy();
            charts.seg = new Chart(ctx, { type:'doughnut', data:{ labels: d.customer_segments.map(s=>s.company), datasets:[{data: d.customer_segments.map(s=>s.count), backgroundColor:['#3b82f6','#8b5cf6','#ec4899','#10b981','#f59e0b'], borderWidth:0}]}, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%' }});
            document.getElementById('topEventsBody').innerHTML = d.top_converting_events.map(e => `<tr><td>${e.name}</td><td class="text-end fw-bold">${e.registrations}</td><td class="text-end text-success">${e.converted}</td><td class="text-end text-primary">${e.rate}%</td></tr>`).join('');
        }

        async function fetchCustomers() {
            const res = await fetch('/customers/'); allCustomers = await res.json();
            document.getElementById('custTableBody').innerHTML = allCustomers.map(c => `<tr><td><div class="fw-bold">${c.name}</div><small class="text-muted">${c.email}</small></td><td>${c.company||'-'}</td><td class="text-center"><i class="bi bi-trash text-danger" onclick="delCustomer(${c.id})" style="cursor:pointer"></i></td></tr>`).join('');
            document.getElementById('custCount').innerText = `總計: ${allCustomers.length}`;
        }

        async function saveCustomer() {
            const data = { name: document.getElementById('c_n').value, email: document.getElementById('c_e').value, company: document.getElementById('c_c').value, phone: document.getElementById('c_p').value };
            if(!data.name || !data.email) { alert('必填！'); return; }
            const res = await fetch('/customers/', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            if(res.ok) { modals.addCust.hide(); await fetchCustomers(); } else { const err = await res.json(); alert('失敗：'+err.detail); }
        }

        async function delCustomer(id) { if(confirm('刪除？')) { await fetch(`/customers/${id}`, {method:'DELETE'}); await fetchCustomers(); } }

        async function loadEvents() {
            const res = await fetch('/customers/events/'); const data = await res.json();
            document.getElementById('evTableBody').innerHTML = data.map(e => `<tr><td><div class="fw-bold">${e.name}</div></td><td>${new Date(e.date).toLocaleDateString()}</td><td>${e.location||'-'}</td><td class="text-center">${e.attendance_rate}%</td></tr>`).join('');
            document.getElementById('evCount').innerText = `總計: ${data.length}`;
        }

        async function saveEvent() {
            const data = { name: document.getElementById('e_n').value, date: document.getElementById('e_d').value, location: document.getElementById('e_l').value };
            const res = await fetch('/customers/events/', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            if(res.ok) { modals.addEv.hide(); await loadEvents(); }
        }

        async function initMarketing() {
            await checkGmailStatus();
            const res = await fetch('/customers/marketing/templates'); emailTemplates = await res.json();
            document.getElementById('mktTpl').innerHTML = '<option value="">-- 選擇範本 --</option>' + emailTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById('mktPickList').innerHTML = allCustomers.map(c => `<tr><td><input type="checkbox" class="mkt-chk" value="${c.id}" onchange="updateMktSel()"></td><td>${c.name}</td></tr>`).join('');
            loadCampaignHistory();
        }

        async function checkGmailStatus() {
            const res = await fetch('/customers/marketing/status');
            const data = await res.json();
            const div = document.getElementById('gmail-status');
            if (data.is_authenticated) {
                div.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Gmail 已連線</span>';
            }
        }

        function startAuth() {
            // 在本地環境直接呼叫 API 觸發 OAuth 流程
            window.location.href = '/customers/marketing/auth';
        }

        function mktSelectAll(el) { document.querySelectorAll('.mkt-chk').forEach(x => x.checked = el.checked); updateMktSel(); }
        function updateMktSel() { selectedIds.clear(); document.querySelectorAll('.mkt-chk:checked').forEach(x => selectedIds.add(parseInt(x.value))); }
        function applyTpl() { const t = emailTemplates.find(x => x.id == document.getElementById('mktTpl').value); if(t) { document.getElementById('mktSub').value = t.subject; document.getElementById('mktBody').value = t.body; } }
        async function saveAsTpl() {
            const n = prompt('範本名？'); if(!n) return;
            await fetch('/customers/marketing/templates', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n, subject:document.getElementById('mktSub').value, body:document.getElementById('mktBody').value})});
            initMarketing();
        }

                        async function createCampaign() {

                            const timeInput = document.getElementById('mktTime').value;

                            let finalTime = timeInput || null; // 直接傳送 yyyy-mm-ddThh:mm 字串

                

                            const data = { 

                                name: document.getElementById('mktCampaignName').value, 

                                subject: document.getElementById('mktSub').value, 

                                body: document.getElementById('mktBody').value, 

                                customer_ids: Array.from(selectedIds), 

                                scheduled_at: finalTime

                            };

                

        
            if(!data.name) { alert('請輸入活動名稱'); return; }
            if(selectedIds.size === 0) { alert('請勾選收件人'); return; }
            const res = await fetch('/customers/marketing/campaigns', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            if(res.ok) { alert('活動已建立！'); await loadCampaignHistory(); }
        }

        async function loadCampaignHistory() {
            const res = await fetch('/customers/marketing/campaigns'); const data = await res.json();
            document.getElementById('mktHistoryBody').innerHTML = data.map(c => {
                let statusCls = "bg-secondary";
                if(c.status === "已完成") statusCls = "bg-success";
                if(c.status === "已排程") statusCls = "bg-primary";
                
                // 處理時間顯示為本地格式
                let timeStr = "立即發送";
                if(c.scheduled_at) {
                    const date = new Date(c.scheduled_at);
                    timeStr = date.toLocaleString('zh-TW', { hour12: true });
                }

                return `<tr><td>${c.name}</td><td><span class="badge ${statusCls}">${c.status}</span></td><td class="text-center fw-bold">${c.total_recipients}</td><td class="text-center fw-bold">${c.opened_count}</td><td class="text-center fw-bold text-primary">${c.open_rate}%</td><td class="text-end small">${timeStr}</td></tr>`;
            }).join('') || '<tr><td colspan="6" class="text-center p-4 text-muted">目前尚無紀錄</td></tr>';
        }

        async function sendTestEmail() {
            const email = document.getElementById('testEmailInput').value;
            if(!email) { alert('請先輸入測試收件信箱'); return; }
            
            try {
                const res = await fetch('/customers/marketing/test', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({
                        email: email, 
                        subject: '【測試】' + document.getElementById('mktSub').value, 
                        body: document.getElementById('mktBody').value
                    })
                });
                const data = await res.json();
                if(res.ok) {
                    alert(data.message);
                } else {
                    alert(data.detail || '測試信發送失敗');
                }
            } catch(e) {
                alert('伺服器連線失敗');
            }
        }

        function openModal(id) { modals[id==='addCustModal'?'addCust':'addEv'].show(); }
    </script>
</body>
</html>
